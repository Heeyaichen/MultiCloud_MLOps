# Azure DevOps Pipeline: ML Model Training
# Trigger: Manual or on schedule/tag

trigger: none  # Manual trigger only

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: guardian-variables
  - name: AZURE_SUBSCRIPTION_ID
    value: 'your-subscription-id'  # Replace with your subscription ID
  - name: AZURE_RESOURCE_GROUP
    value: 'rg-guardian-ai-prod'
  - name: AZURE_ML_WORKSPACE
    value: 'guardian-ml-workspace'
  - name: COMPUTE_CLUSTER
    value: 'cpu-training-cluster'

stages:
  - stage: TrainModels
    displayName: 'Train ML Models'
    jobs:
      - job: TrainNSFWModel
        displayName: 'Train NSFW Detection Model'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.11'
            displayName: 'Use Python 3.11'

          - script: |
              python -m pip install --upgrade pip
              pip install azure-ai-ml azure-identity mlflow torch torchvision transformers pillow numpy
            displayName: 'Install dependencies'

          - task: AzureCLI@2
            displayName: 'Azure Login'
            inputs:
              azureSubscription: 'guardian-azure-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az account set --subscription $(AZURE_SUBSCRIPTION_ID)

          - script: |
              export AZURE_SUBSCRIPTION_ID="$(AZURE_SUBSCRIPTION_ID)"
              export AZURE_RESOURCE_GROUP="$(AZURE_RESOURCE_GROUP)"
              export AZURE_ML_WORKSPACE="$(AZURE_ML_WORKSPACE)"
              export MLFLOW_TRACKING_URI="azureml://$(AZURE_ML_WORKSPACE).api.azureml.ms/mlflow/v1.0/subscriptions/$(AZURE_SUBSCRIPTION_ID)/resourceGroups/$(AZURE_RESOURCE_GROUP)/providers/Microsoft.MachineLearningServices/workspaces/$(AZURE_ML_WORKSPACE)"
              
              cd mlops/training
              python train_nsfw_model.py
            displayName: 'Train NSFW Model'
            env:
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)
              AZURE_ML_WORKSPACE: $(AZURE_ML_WORKSPACE)

      - job: TrainViolenceModel
        displayName: 'Train Violence Detection Model'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.11'

          - script: |
              python -m pip install --upgrade pip
              pip install azure-ai-ml azure-identity mlflow torch torchvision transformers pillow numpy
            displayName: 'Install dependencies'

          - task: AzureCLI@2
            displayName: 'Azure Login'
            inputs:
              azureSubscription: 'guardian-azure-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az account set --subscription $(AZURE_SUBSCRIPTION_ID)

          - script: |
              export AZURE_SUBSCRIPTION_ID="$(AZURE_SUBSCRIPTION_ID)"
              export AZURE_RESOURCE_GROUP="$(AZURE_RESOURCE_GROUP)"
              export AZURE_ML_WORKSPACE="$(AZURE_ML_WORKSPACE)"
              export MLFLOW_TRACKING_URI="azureml://$(AZURE_ML_WORKSPACE).api.azureml.ms/mlflow/v1.0/subscriptions/$(AZURE_SUBSCRIPTION_ID)/resourceGroups/$(AZURE_RESOURCE_GROUP)/providers/Microsoft.MachineLearningServices/workspaces/$(AZURE_ML_WORKSPACE)"
              
              cd mlops/training
              python train_nsfw_model.py  # Modify to train violence model or create separate script
            displayName: 'Train Violence Model'
            env:
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)
              AZURE_ML_WORKSPACE: $(AZURE_ML_WORKSPACE)
